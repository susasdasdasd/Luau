local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local TextChatService = game:GetService("TextChatService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local CoreGui = game:GetService("CoreGui")

local lp = Players.LocalPlayer
local stashPos = Vector3.new(1234527, 1232974, 1234405)
local PLATFORM_NAME = "Stash_Education_Platform"

local customSpawnEnabled = false
local CLONE_COUNT = 6
local REPEAT_DELAY = 7
local CHAT_DELAY = 1.8
local GRAB_RANGE = 100

local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "MasterStashV8"
ScreenGui.ResetOnSpawn = false
pcall(function() ScreenGui.Parent = CoreGui end)
if not ScreenGui.Parent then ScreenGui.Parent = lp:WaitForChild("PlayerGui") end

local MainFrame = Instance.new("Frame")
MainFrame.Size = UDim2.new(0, 260, 0, 70)
MainFrame.Position = UDim2.new(0.5, -130, 0.4, 0)
MainFrame.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
MainFrame.Active = true
MainFrame.Parent = ScreenGui
Instance.new("UICorner", MainFrame)

local MainButton = Instance.new("TextButton")
MainButton.Size = UDim2.new(1, -25, 1, -25)
MainButton.Position = UDim2.new(0, 10, 0, 10)
MainButton.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
MainButton.Text = "L: START | R: MENU"
MainButton.TextColor3 = Color3.new(1, 1, 1)
MainButton.Font = Enum.Font.GothamBold
MainButton.Parent = MainFrame
Instance.new("UICorner", MainButton)

local ResizeHandle = Instance.new("TextButton")
ResizeHandle.Size = UDim2.new(0, 20, 0, 20)
ResizeHandle.Position = UDim2.new(1, -20, 1, -20)
ResizeHandle.BackgroundTransparency = 1
ResizeHandle.Text = "â—¢"
ResizeHandle.TextColor3 = Color3.new(0.5, 0.5, 0.5)
ResizeHandle.ZIndex = 10
ResizeHandle.Parent = MainFrame

local MenuFrame = Instance.new("Frame")
MenuFrame.Size = UDim2.new(1, 0, 0, 180)
MenuFrame.Position = UDim2.new(0, 0, 1.1, 0)
MenuFrame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
MenuFrame.Visible = false
MenuFrame.Parent = MainFrame
Instance.new("UICorner", MenuFrame)

local function CreateBtn(txt, pos, color)
    local b = Instance.new("TextButton")
    b.Size = UDim2.new(0.9, 0, 0, 25)
    b.Position = pos
    b.BackgroundColor3 = color
    b.Text = txt
    b.TextColor3 = Color3.new(1, 1, 1)
    b.Font = Enum.Font.GothamBold
    b.TextSize = 11
    b.Parent = MenuFrame
    Instance.new("UICorner", b)
    return b
end

local TPBtn = CreateBtn("TP & BUILD PLATFORM", UDim2.new(0.05, 0, 0.05, 0), Color3.fromRGB(0, 100, 60))
local SpawnBtn = CreateBtn("CUSTOM SPAWN: OFF", UDim2.new(0.05, 0, 0.25, 0), Color3.fromRGB(60, 60, 60))
local UnstashBtn = CreateBtn("UNSTASH (GRAB TOOLS)", UDim2.new(0.05, 0, 0.45, 0), Color3.fromRGB(130, 40, 40))

local InputBox = Instance.new("TextBox")
InputBox.Size = UDim2.new(0.4, 0, 0, 25)
InputBox.Position = UDim2.new(0.3, 0, 0.7, 0)
InputBox.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
InputBox.TextColor3 = Color3.new(1, 1, 1)
InputBox.Text = "6"
InputBox.PlaceholderText = "1-15"
InputBox.Parent = MenuFrame
Instance.new("UICorner", InputBox)

local function EnsurePlatform()
    local p = workspace:FindFirstChild(PLATFORM_NAME)
    if not p then
        p = Instance.new("Part", workspace)
        p.Name = PLATFORM_NAME
        p.Size = Vector3.new(200, 1, 200)
        p.Position = stashPos
        p.Anchored = true
    end
    return p
end

local function Say(msg)
    local chat = TextChatService:FindFirstChild("TextChannels") and TextChatService.TextChannels:FindFirstChild("RBXGeneral")
    if chat then chat:SendAsync(msg) else
        local r = ReplicatedStorage:FindFirstChild("DefaultChatSystemChatEvents")
        if r then r.SayMessageRequest:FireServer(msg, "All") end
    end
    task.wait(CHAT_DELAY)
end

local function GrabTools()
    local char = lp.Character
    if not char then return end
    local bucket = char:FindFirstChild("BlueBucket") or char:FindFirstChildOfClass("Tool")
    for _, item in pairs(workspace:GetChildren()) do
        if item:IsA("Tool") or (item:IsA("Part") and item:FindFirstChildOfClass("TouchTransmitter")) then
            local root = char:FindFirstChild("HumanoidRootPart")
            if root and (root.Position - item:GetPivot().Position).Magnitude <= GRAB_RANGE then
                item.Parent = bucket or char
            end
        end
    end
end

lp.CharacterAdded:Connect(function(char)
    if customSpawnEnabled then
        local hrp = char:WaitForChild("HumanoidRootPart", 5)
        if hrp then task.wait(0.5); hrp.CFrame = CFrame.new(stashPos + Vector3.new(0, 5, 0)) end
    end
end)

SpawnBtn.MouseButton1Click:Connect(function()
    customSpawnEnabled = not customSpawnEnabled
    EnsurePlatform()
    SpawnBtn.Text = customSpawnEnabled and "CUSTOM SPAWN: ON" or "CUSTOM SPAWN: OFF"
    SpawnBtn.BackgroundColor3 = customSpawnEnabled and Color3.fromRGB(0, 120, 200) or Color3.fromRGB(60, 60, 60)
end)

TPBtn.MouseButton1Click:Connect(function()
    EnsurePlatform()
    if lp.Character then lp.Character.HumanoidRootPart.CFrame = CFrame.new(stashPos + Vector3.new(0, 5, 0)) end
end)

UnstashBtn.MouseButton1Click:Connect(function()
    UnstashBtn.Text = "COLLECTING..."
    local endT = tick() + 1.2
    while tick() < endT do GrabTools(); task.wait(0.1) end
    UnstashBtn.Text = "UNSTASH (GRAB TOOLS)"
end)

MainButton.MouseButton1Click:Connect(function()
    if MenuFrame.Visible then return end
    local char = lp.Character
    if not char or not char:FindFirstChild("HumanoidRootPart") then return end
    EnsurePlatform()
    for i = 1, CLONE_COUNT do
        local row = math.floor((i-1) / 5)
        local col = (i-1) % 5
        if row % 2 == 1 then col = 4 - col end
        local tPos = stashPos + Vector3.new(col * 15 - 30, 5, row * 15 - 40)
        char.HumanoidRootPart.CFrame = CFrame.new(tPos) * CFrame.Angles(0, math.rad(180), 0)
        task.wait(0.5)
        for _, t in pairs(lp.Backpack:GetChildren()) do if t:IsA("Tool") then t.Parent = char end end
        task.wait(0.3)
        Say(";freeze me"); Say(";clone me")
        char.HumanoidRootPart.CFrame = CFrame.new(stashPos + Vector3.new(0, 10, 0))
        task.wait(0.5); Say(";unfreeze me")
        for cd = REPEAT_DELAY, 1, -1 do MainButton.Text = "WAIT: "..cd.."s"; task.wait(1) end
    end
    MainButton.Text = "L: START | R: MENU"
end)

MainButton.MouseButton2Click:Connect(function() MenuFrame.Visible = not MenuFrame.Visible end)

InputBox.FocusLost:Connect(function()
    local n = tonumber(InputBox.Text)
    if n and n >= 1 and n <= 15 then CLONE_COUNT = n else InputBox.Text = tostring(CLONE_COUNT) end
end)

local function InitUI()
    local d, r, dS, rS, sP, sS
    MainFrame.InputBegan:Connect(function(i) if i.UserInputType == Enum.UserInputType.MouseButton1 then d = true dS = i.Position sP = MainFrame.Position end end)
    ResizeHandle.InputBegan:Connect(function(i) if i.UserInputType == Enum.UserInputType.MouseButton1 then r = true rS = i.Position sS = MainFrame.Size end end)
    UserInputService.InputChanged:Connect(function(i)
        if d and i.UserInputType == Enum.UserInputType.MouseMovement then
            local delta = i.Position - dS
            MainFrame.Position = UDim2.new(sP.X.Scale, sP.X.Offset + delta.X, sP.Y.Scale, sP.Y.Offset + delta.Y)
        elseif r and i.UserInputType == Enum.UserInputType.MouseMovement then
            local delta = i.Position - rS
            MainFrame.Size = UDim2.new(0, math.max(180, sS.X.Offset + delta.X), 0, math.max(60, sS.Y.Offset + delta.Y))
        end
    end)
    UserInputService.InputEnded:Connect(function() d = false r = false end)
end
InitUI()

--[[
    MasterStash V26.1 - Integrated Edition
    Features: 
    - Auto-Gear (;gear me 25162389)
    - Dual Smooth Black Platforms
    - Toggle Start/Stop Logic
    - Super Ring V4 + Extra Ring (Pastebin)
]]

local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local TextChatService = game:GetService("TextChatService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local RunService = game:GetService("RunService")
local CoreGui = game:GetService("CoreGui")

-- Safety: Ensure LocalPlayer and PlayerGui are ready
local lp = Players.LocalPlayer
while not lp do task.wait() lp = Players.LocalPlayer end
local pGui = lp:WaitForChild("PlayerGui")

-- Clean up old UI versions
local existing = CoreGui:FindFirstChild("MasterStashV26") or pGui:FindFirstChild("MasterStashV26")
if existing then existing:Destroy() end

-- UI Container
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "MasterStashV26"
ScreenGui.ResetOnSpawn = false

-- Fallback parenting for executors
local success, _ = pcall(function() ScreenGui.Parent = CoreGui end)
if not success then ScreenGui.Parent = pGui end

-- PLATFORM CONFIGURATIONS
local PLATFORMS = {
    [1] = {Pos = Vector3.new(1234527, 1232974, 1234405), Name = "Stash_Platform_1"},
    [2] = {Pos = Vector3.new(1235527, 1232974, 1235405), Name = "Stash_Platform_2"}
}

local activePlatformIdx = 1
local customSpawnEnabled = false
local CLONE_COUNT = 1
local REPEAT_DELAY = 7
local CHAT_DELAY = 1.8
local GRAB_RANGE = 100
local currentDir = "North"
local isStashing = false

-- SHARED NETWORK SETTINGS (Required for Rings)
if not getgenv().Network then
    getgenv().Network = {
        BaseParts = {},
        Velocity = Vector3.new(14.46, 14.46, 14.46)
    }
    RunService.Heartbeat:Connect(function()
        sethiddenproperty(lp, "SimulationRadius", math.huge)
        for _, Part in pairs(getgenv().Network.BaseParts) do
            if Part:IsDescendantOf(workspace) then Part.Velocity = getgenv().Network.Velocity end
        end
    end)
end

-- MAIN UI ELEMENTS
local MainFrame = Instance.new("Frame")
MainFrame.Size = UDim2.new(0, 260, 0, 70)
MainFrame.Position = UDim2.new(0.5, -130, 0.4, 0)
MainFrame.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
MainFrame.Active = true
MainFrame.Parent = ScreenGui
Instance.new("UICorner", MainFrame)

local MainButton = Instance.new("TextButton")
MainButton.Size = UDim2.new(1, -25, 1, -25)
MainButton.Position = UDim2.new(0, 10, 0, 10)
MainButton.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
MainButton.Text = "L: START | R: MENU"
MainButton.TextColor3 = Color3.new(1, 1, 1)
MainButton.Font = Enum.Font.GothamBold
MainButton.Parent = MainFrame
Instance.new("UICorner", MainButton)

local MenuFrame = Instance.new("Frame")
MenuFrame.Size = UDim2.new(1, 0, 0, 310) 
MenuFrame.Position = UDim2.new(0, 0, 1.1, 0)
MenuFrame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
MenuFrame.Visible = false
MenuFrame.Parent = MainFrame
Instance.new("UICorner", MenuFrame)

local function CreateBtn(txt, pos, color)
    local b = Instance.new("TextButton")
    b.Size = UDim2.new(0.9, 0, 0, 25)
    b.Position = pos
    b.BackgroundColor3 = color
    b.Text = txt
    b.TextColor3 = Color3.new(1, 1, 1)
    b.Font = Enum.Font.GothamBold
    b.TextSize = 11
    b.Parent = MenuFrame
    Instance.new("UICorner", b)
    return b
end

-- MENU BUTTONS
local PlatformBtn = CreateBtn("TARGET PLATFORM: 1", UDim2.new(0.05, 0, 0.05, 0), Color3.fromRGB(100, 100, 0))
local TPBtn = CreateBtn("TP & BUILD ALL PLATFORMS", UDim2.new(0.05, 0, 0.15, 0), Color3.fromRGB(0, 100, 60))
local SpawnBtn = CreateBtn("CUSTOM SPAWN: OFF", UDim2.new(0.05, 0, 0.25, 0), Color3.fromRGB(60, 60, 60))
local UnstashBtn = CreateBtn("UNSTASH (GRAB TOOLS)", UDim2.new(0.05, 0, 0.35, 0), Color3.fromRGB(130, 40, 40))
local DirBtn = CreateBtn("SIDE: NORTH", UDim2.new(0.05, 0, 0.45, 0), Color3.fromRGB(80, 40, 120))
local OrbitBtn = CreateBtn("LOAD SUPER RING V4", UDim2.new(0.05, 0, 0.55, 0), Color3.fromRGB(153, 0, 0))
local ExtraRingBtn = CreateBtn("LOAD EXTRA RING (PASTEBIN)", UDim2.new(0.05, 0, 0.65, 0), Color3.fromRGB(0, 80, 150))

local InputBox = Instance.new("TextBox")
InputBox.Size = UDim2.new(0.4, 0, 0, 25)
InputBox.Position = UDim2.new(0.3, 0, 0.82, 0)
InputBox.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
InputBox.TextColor3 = Color3.new(1, 1, 1)
InputBox.PlaceholderText = "1-15 Clones"
InputBox.Text = "1"
InputBox.Parent = MenuFrame
Instance.new("UICorner", InputBox)

-- LOGIC FUNCTIONS
local function BuildAllPlatforms()
    for _, data in pairs(PLATFORMS) do
        local p = workspace:FindFirstChild(data.Name)
        if not p then
            p = Instance.new("Part", workspace)
            p.Name = data.Name
            p.Size = Vector3.new(200, 1, 200)
            p.Position = data.Pos
            p.Anchored = true
            p.Material = Enum.Material.SmoothPlastic
            p.Color = Color3.fromRGB(0, 0, 0)
        end
    end
end

local function Say(msg)
    local chat = TextChatService:FindFirstChild("TextChannels") and TextChatService.TextChannels:FindFirstChild("RBXGeneral")
    if chat then chat:SendAsync(msg) else
        local r = ReplicatedStorage:FindFirstChild("DefaultChatSystemChatEvents")
        if r then r.SayMessageRequest:FireServer(msg, "All") end
    end
    task.wait(CHAT_DELAY)
end

-- INTERACTIONS
InputBox.FocusLost:Connect(function()
    local val = tonumber(InputBox.Text)
    if val and val >= 1 and val <= 15 then CLONE_COUNT = math.floor(val) else CLONE_COUNT = 1 end
    InputBox.Text = tostring(CLONE_COUNT)
end)

PlatformBtn.MouseButton1Click:Connect(function()
    activePlatformIdx = (activePlatformIdx == 1) and 2 or 1
    PlatformBtn.Text = "TARGET PLATFORM: " .. activePlatformIdx
end)

OrbitBtn.MouseButton1Click:Connect(function()
    loadstring(game:HttpGet("https://raw.githubusercontent.com/Lukashub-coder/super-ring/refs/heads/main/Super%20ring!!"))()
    OrbitBtn.Text = "SUPER RING LOADED"
end)

ExtraRingBtn.MouseButton1Click:Connect(function()
    loadstring(game:HttpGet("https://pastebin.com/raw/QYUALL7N"))()
    ExtraRingBtn.Text = "EXTRA RING LOADED"
end)

DirBtn.MouseButton1Click:Connect(function()
    local dirs = {"North", "East", "South", "West"}
    local idx = table.find(dirs, currentDir) or 1
    currentDir = dirs[idx % 4 + 1]
    DirBtn.Text = "SIDE: " .. currentDir:upper()
end)

MainButton.MouseButton1Click:Connect(function()
    if MenuFrame.Visible then return end
    if isStashing then isStashing = false; MainButton.Text = "STOPPING..."; return end

    local char = lp.Character
    if not char or not char:FindFirstChild("HumanoidRootPart") then return end
    
    isStashing = true
    BuildAllPlatforms()
    local data = PLATFORMS[activePlatformIdx]
    
    for i = 1, CLONE_COUNT do
        if not isStashing then break end
        Say(";gear me 25162389")
        
        local row, col = math.floor((i-1) / 5), (i-1) % 5
        if row % 2 == 1 then col = 4 - col end
        local gridX, gridZ = col * 15 - 30, row * 15
        local finalPos, faceAngle
        
        if currentDir == "North" then finalPos = data.Pos + Vector3.new(gridX, 5, -80 + gridZ); faceAngle = 180
        elseif currentDir == "South" then finalPos = data.Pos + Vector3.new(-gridX, 5, 80 - gridZ); faceAngle = 0
        elseif currentDir == "East" then finalPos = data.Pos + Vector3.new(80 - gridZ, 5, gridX); faceAngle = 90
        elseif currentDir == "West" then finalPos = data.Pos + Vector3.new(-80 + gridZ, 5, -gridX); faceAngle = -90 end

        char.HumanoidRootPart.CFrame = CFrame.new(finalPos) * CFrame.Angles(0, math.rad(faceAngle), 0)
        task.wait(0.5)
        for _, t in pairs(lp.Backpack:GetChildren()) do if t:IsA("Tool") then t.Parent = char end end
        task.wait(0.3)
        
        if not isStashing then break end
        Say(";freeze me")
        Say(";clone me")
        
        char.HumanoidRootPart.CFrame = CFrame.new(data.Pos + Vector3.new(0, 10, 0))
        task.wait(0.5)
        Say(";unfreeze me")
        
        for cd = REPEAT_DELAY, 1, -1 do 
            if not isStashing then break end
            MainButton.Text = "WAIT: "..cd.."s (TAP TO STOP)"
            task.wait(1) 
        end
    end
    isStashing = false; MainButton.Text = "L: START | R: MENU"
end)

UnstashBtn.MouseButton1Click:Connect(function()
    UnstashBtn.Text = "COLLECTING..."
    local endT = tick() + 1.2
    while tick() < endT do 
        local char = lp.Character
        local hrp = char and char:FindFirstChild("HumanoidRootPart")
        if hrp then
            for _, item in pairs(workspace:GetChildren()) do
                if item:IsA("Tool") or item:FindFirstChildOfClass("TouchTransmitter") then
                    if (hrp.Position - item:GetPivot().Position).Magnitude <= GRAB_RANGE then
                        item.Parent = char
                    end
                end
            end
        end
        task.wait(0.1) 
    end
    UnstashBtn.Text = "UNSTASH (GRAB TOOLS)"
end)

SpawnBtn.MouseButton1Click:Connect(function()
    customSpawnEnabled = not customSpawnEnabled
    SpawnBtn.Text = customSpawnEnabled and "CUSTOM SPAWN: ON" or "CUSTOM SPAWN: OFF"
    SpawnBtn.BackgroundColor3 = customSpawnEnabled and Color3.fromRGB(0, 120, 200) or Color3.fromRGB(60, 60, 60)
end)

lp.CharacterAdded:Connect(function(char)
    if customSpawnEnabled then
        local data = PLATFORMS[activePlatformIdx]
        local hrp = char:WaitForChild("HumanoidRootPart", 5)
        if hrp then task.wait(0.6); hrp.CFrame = CFrame.new(data.Pos + Vector3.new(0, 5, 0)) end
    end
end)

TPBtn.MouseButton1Click:Connect(function() 
    BuildAllPlatforms()
    local data = PLATFORMS[activePlatformIdx]
    if lp.Character and lp.Character:FindFirstChild("HumanoidRootPart") then
        lp.Character.HumanoidRootPart.CFrame = CFrame.new(data.Pos + Vector3.new(0, 5, 0))
    end
end)

MainButton.MouseButton2Click:Connect(function() MenuFrame.Visible = not MenuFrame.Visible end)

-- UI DRAGGING
local function InitUI()
    local dragging, dragStart, startPos
    MainFrame.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = true; dragStart = input.Position; startPos = MainFrame.Position
        end
    end)
    UserInputService.InputChanged:Connect(function(input)
        if dragging and input.UserInputType == Enum.UserInputType.MouseMovement then
            local delta = input.Position - dragStart
            MainFrame.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
        end
    end)
    UserInputService.InputEnded:Connect(function() dragging = false end)
end
InitUI()
